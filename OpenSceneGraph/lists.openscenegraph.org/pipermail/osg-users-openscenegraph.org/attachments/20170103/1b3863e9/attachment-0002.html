<tt>
&lt;div&nbsp;dir=&quot;ltr&quot;&gt;&lt;div&gt;&lt;div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;When&nbsp;loading&nbsp;.obj&nbsp;files&nbsp;(e.g.&nbsp;exported&nbsp;from&nbsp;Blender)&nbsp;into&nbsp;OSG&nbsp;-&nbsp;especially&nbsp;those&nbsp;that&nbsp;are&nbsp;exported&nbsp;with&nbsp;the&nbsp;&quot;group&nbsp;by&nbsp;material&quot;&nbsp;option&nbsp;-&nbsp;you&nbsp;might&nbsp;find&nbsp;a&nbsp;lot&nbsp;of&nbsp;individual&nbsp;tri&nbsp;strips&nbsp;in&nbsp;the&nbsp;resulting&nbsp;OSG&nbsp;geometry.&lt;br&gt;&lt;br&gt;&lt;/div&gt;Here&nbsp;is&nbsp;a&nbsp;piece&nbsp;of&nbsp;code&nbsp;(a&nbsp;node&nbsp;visitor)&nbsp;that&nbsp;will&nbsp;join&nbsp;these&nbsp;tri&nbsp;strips&nbsp;into&nbsp;a&nbsp;single&nbsp;large&nbsp;strip,&nbsp;taking&nbsp;into&nbsp;account&nbsp;cache&nbsp;locality&nbsp;aspects:&nbsp;The&nbsp;tri&nbsp;strips&nbsp;are&nbsp;sorted&nbsp;by&nbsp;their&nbsp;median&nbsp;vertex&nbsp;index&nbsp;before&nbsp;joining.&nbsp;This&nbsp;can&nbsp;be&nbsp;useful&nbsp;to&nbsp;improve&nbsp;the&nbsp;performance&nbsp;of&nbsp;hardware&nbsp;instancing.&lt;br&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Some&nbsp;C++11&nbsp;language&nbsp;features&nbsp;may&nbsp;be&nbsp;used&nbsp;in&nbsp;the&nbsp;code&nbsp;(range&nbsp;based&nbsp;for&nbsp;and&nbsp;others).&nbsp;Feel&nbsp;free&nbsp;to&nbsp;modify/use/improve&nbsp;on&nbsp;this&nbsp;code.&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;Christian&lt;br&gt;&lt;div&gt;&lt;br&gt;/**&lt;br&gt; *&nbsp;A&nbsp;visitor&nbsp;that&nbsp;merges&nbsp;triangle&nbsp;strip&nbsp;drawables&nbsp;by&nbsp;creating&nbsp;some&nbsp;degenerate&nbsp;triangles.&lt;br&gt; */&lt;br&gt;class&nbsp;TriStripMergeVisitor&nbsp;:&nbsp;public&nbsp;osg::NodeVisitor&lt;br&gt;{&lt;br&gt;public:&lt;br&gt;&lt;br&gt;   &nbsp;TriStripMergeVisitor():&lt;br&gt;       &nbsp;osg::NodeVisitor(osg::NodeVisitor::TRAVERSE_ALL_CHILDREN)&nbsp;{}&lt;br&gt;&lt;br&gt;   &nbsp;virtual&nbsp;void&nbsp;apply(osg::Node&amp;&nbsp;node)&lt;br&gt;   &nbsp;{&lt;br&gt;       &nbsp;traverse(node);&lt;br&gt;   &nbsp;}&lt;br&gt;&lt;br&gt;   &nbsp;virtual&nbsp;void&nbsp;apply(osg::Geode&amp;&nbsp;node)&lt;br&gt;   &nbsp;{&lt;br&gt;       &nbsp;for(unsigned&nbsp;int&nbsp;i=0;i&lt;node.getNumDrawables();++i)&lt;br&gt;       &nbsp;{&lt;br&gt;           &nbsp;osg::Drawable*&nbsp;drawable&nbsp;=&nbsp;node.getDrawable(i);&lt;br&gt;           &nbsp;if&nbsp;(drawable)&nbsp;apply(*drawable);&lt;br&gt;       &nbsp;}&lt;br&gt;&lt;br&gt;       &nbsp;traverse(node);&lt;br&gt;   &nbsp;}&lt;br&gt;&lt;br&gt;   &nbsp;virtual&nbsp;void&nbsp;apply(osg::Drawable&amp;&nbsp;drawable)&lt;br&gt;   &nbsp;{&lt;br&gt;       &nbsp;osg::Geometry&nbsp;*geo&nbsp;=&nbsp;dynamic_cast&lt;osg::Geometry*&gt;(&amp;drawable);&lt;br&gt;       &nbsp;if&nbsp;(geo&nbsp;!=&nbsp;NULL)&nbsp;apply(*geo);&lt;br&gt;   &nbsp;}&lt;br&gt;&lt;br&gt;   &nbsp;virtual&nbsp;void&nbsp;apply(osg::Geometry&amp;&nbsp;geometry)&lt;br&gt;   &nbsp;{&lt;br&gt;       &nbsp;osg::Geometry::PrimitiveSetList&nbsp;&amp;psl&nbsp;=&nbsp;geometry.getPrimitiveSetList();&lt;br&gt;&lt;br&gt;       &nbsp;//&nbsp;count&nbsp;the&nbsp;number&nbsp;of&nbsp;tri&nbsp;strips&lt;br&gt;       &nbsp;int&nbsp;num_tristrips&nbsp;=&nbsp;0;&lt;br&gt;       &nbsp;unsigned&nbsp;int&nbsp;total_indices&nbsp;=&nbsp;0;&lt;br&gt;       &nbsp;std::vector&lt;&nbsp;std::pair&lt;std::vector&lt;unsigned&nbsp;int&gt;,&nbsp;unsigned&nbsp;int&gt;&nbsp;&gt;&nbsp;tristrips;&lt;br&gt;       &nbsp;bool&nbsp;first&nbsp;=&nbsp;true;&lt;br&gt;       &nbsp;for&nbsp;(auto&nbsp;&amp;ps&nbsp;:&nbsp;psl)&lt;br&gt;       &nbsp;{&lt;br&gt;           &nbsp;osg::DrawElements&nbsp;*de&nbsp;=&nbsp;dynamic_cast&lt;osg::DrawElements*&gt;(ps.get());&lt;br&gt;           &nbsp;if&nbsp;(de&nbsp;!=&nbsp;NULL)&lt;br&gt;           &nbsp;{&lt;br&gt;               &nbsp;if&nbsp;(de-&gt;getMode()&nbsp;==&nbsp;osg::PrimitiveSet::TRIANGLE_STRIP)&lt;br&gt;               &nbsp;{&lt;br&gt;                   &nbsp;num_tristrips++;&lt;br&gt;                   &nbsp;std::vector&lt;unsigned&nbsp;int&gt;&nbsp;indices;&lt;br&gt;                   &nbsp;unsigned&nbsp;int&nbsp;num_indices&nbsp;=&nbsp;de-&gt;getNumIndices();&lt;br&gt;                   &nbsp;if&nbsp;(!first)&nbsp;total_indices&nbsp;+=&nbsp;2;&lt;br&gt;                   &nbsp;total_indices&nbsp;+=&nbsp;num_indices;&lt;br&gt;                   &nbsp;indices.reserve(num_indices);&lt;br&gt;                   &nbsp;for&nbsp;(unsigned&nbsp;int&nbsp;i=0;&nbsp;i&nbsp;&lt;&nbsp;num_indices;&nbsp;i++)&nbsp;indices.push_back(de-&gt;index(i));&lt;br&gt;&lt;br&gt;                   &nbsp;std::vector&lt;unsigned&nbsp;int&gt;&nbsp;sorted_indices(indices);&lt;br&gt;                   &nbsp;std::sort(sorted_indices.begin(),&nbsp;sorted_indices.end());&lt;br&gt;                   &nbsp;int&nbsp;median_index&nbsp;=&nbsp;sorted_indices[sorted_indices.size()/2];&lt;br&gt;                   &nbsp;tristrips.emplace_back(indices,&nbsp;median_index);&lt;br&gt;                   &nbsp;first&nbsp;=&nbsp;false;&lt;br&gt;               &nbsp;}&lt;br&gt;           &nbsp;}&lt;br&gt;       &nbsp;}&lt;br&gt;&lt;br&gt;       &nbsp;//&nbsp;merge&nbsp;all&nbsp;tri-strips&nbsp;in&nbsp;a&nbsp;cache-friendly&nbsp;manner&lt;br&gt;       &nbsp;if&nbsp;(num_tristrips&nbsp;&gt;=&nbsp;2)&lt;br&gt;       &nbsp;{&lt;br&gt;           &nbsp;std::sort(tristrips.begin(),&nbsp;tristrips.end(),&nbsp;[](std::pair&lt;std::vector&lt;unsigned&nbsp;int&gt;,&nbsp;unsigned&nbsp;int&gt;&nbsp;&amp;a,&nbsp;std::pair&lt;std::vector&lt;unsigned&nbsp;int&gt;,&nbsp;unsigned&nbsp;int&gt;&nbsp;&amp;b)&nbsp;{&lt;br&gt;               &nbsp;return&nbsp;b.second&nbsp;&gt;&nbsp;a.second;  &nbsp;&lt;br&gt;           &nbsp;});&lt;br&gt;&lt;br&gt;           &nbsp;std::vector&lt;&nbsp;unsigned&nbsp;int&nbsp;&gt;&nbsp;joined_tristrips;&lt;br&gt;           &nbsp;joined_tristrips.reserve(total_indices);&lt;br&gt;           &nbsp;first&nbsp;=&nbsp;true;&lt;br&gt;           &nbsp;for&nbsp;(auto&nbsp;ts&nbsp;:&nbsp;tristrips)&lt;br&gt;           &nbsp;{&lt;br&gt;               &nbsp;if&nbsp;(!first)&lt;br&gt;               &nbsp;{&lt;br&gt;                   &nbsp;joined_tristrips.push_back(joined_tristrips.back());&lt;br&gt;                   &nbsp;joined_tristrips.push_back(ts.first.front());&lt;br&gt;               &nbsp;}&lt;br&gt;               &nbsp;joined_tristrips.insert(joined_tristrips.end(),&nbsp;ts.first.begin(),&nbsp;ts.first.end());&lt;br&gt;&lt;br&gt;               &nbsp;first&nbsp;=&nbsp;false;&lt;br&gt;           &nbsp;}&lt;br&gt;&lt;br&gt;           &nbsp;unsigned&nbsp;int&nbsp;max_element&nbsp;=&nbsp;*std::max_element(joined_tristrips.begin(),&nbsp;joined_tristrips.end());&lt;br&gt;           &nbsp;osg::ref_ptr&lt;osg::DrawElements&gt;&nbsp;new_de;&lt;br&gt;           &nbsp;if&nbsp;(max_element&nbsp;&lt;&nbsp;256)       &nbsp;new_de&nbsp;=&nbsp;new&nbsp;osg::DrawElementsUByte(osg::PrimitiveSet::TRIANGLE_STRIP,&nbsp;joined_tristrips.size());&lt;br&gt;           &nbsp;else&nbsp;if&nbsp;(max_element&nbsp;&lt;&nbsp;65536)&nbsp;new_de&nbsp;=&nbsp;new&nbsp;osg::DrawElementsUShort(osg::PrimitiveSet::TRIANGLE_STRIP,&nbsp;joined_tristrips.size());&lt;br&gt;           &nbsp;else                         &nbsp;new_de&nbsp;=&nbsp;new&nbsp;osg::DrawElementsUInt(osg::PrimitiveSet::TRIANGLE_STRIP,&nbsp;joined_tristrips.size());&lt;br&gt;           &nbsp;for&nbsp;(unsigned&nbsp;int&nbsp;i=0;&nbsp;i&nbsp;&lt;&nbsp;joined_tristrips.size();&nbsp;i++)&lt;br&gt;               &nbsp;new_de-&gt;setElement(i,&nbsp;joined_tristrips[i]);&lt;br&gt;&lt;br&gt;           &nbsp;osg::Geometry::PrimitiveSetList&nbsp;new_psl;&lt;br&gt;           &nbsp;new_psl.push_back(new_de);&lt;br&gt;&lt;br&gt;           &nbsp;//&nbsp;append&nbsp;all&nbsp;non&nbsp;tri&nbsp;strip&nbsp;geometry&lt;br&gt;           &nbsp;for&nbsp;(auto&nbsp;&amp;ps&nbsp;:&nbsp;psl)&lt;br&gt;           &nbsp;{&lt;br&gt;               &nbsp;osg::DrawElements&nbsp;*de&nbsp;=&nbsp;dynamic_cast&lt;osg::DrawElements*&gt;(ps.get());&lt;br&gt;               &nbsp;if&nbsp;(!(de&nbsp;!=&nbsp;NULL&nbsp;&amp;&amp;&nbsp;de-&gt;getMode()&nbsp;==&nbsp;osg::PrimitiveSet::TRIANGLE_STRIP))&lt;br&gt;                    &nbsp;new_psl.push_back(ps);&lt;br&gt;           &nbsp;}&lt;br&gt;&lt;br&gt;           &nbsp;geometry.setPrimitiveSetList(new_psl);&lt;br&gt;       &nbsp;}&lt;br&gt;   &nbsp;}&lt;br&gt;};&lt;br&gt;&lt;br&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;
</tt>
